<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Work Calendar â€¢ Shared Photo Gallery</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#0f172a; --bg2:#111827; --panel:#0b1220; --card:#0d1529;
    --text:#e5e7eb; --muted:#94a3b8; --line:#1f2a44;
    --primary:#22d3ee; --primary-2:#06b6d4; --ring:rgba(34,211,238,.35);
    --accent:#a78bfa; --success:#22c55e; --danger:#ef4444; --warning:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text)}
  a{color:inherit;text-decoration:none}

  /* Top */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;
    background:linear-gradient(90deg,#0f172a,#0b1220);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:20}
  .brand{display:flex;align-items:center;gap:12px}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--primary);box-shadow:0 0 16px var(--primary)}
  .brand h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
  .hint{font-size:12px;color:var(--muted)}

  /* Calendar shell */
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
    border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.25)}
  .calendar{padding:18px}

  .cal-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
  .cal-title{font-size:22px;font-weight:700;display:flex;align-items:center;gap:10px}
  .seg{display:flex;gap:8px}
  .btn{background:#0f172a;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:.2s}
  .btn:hover{border-color:#2b3b63;box-shadow:0 0 0 3px var(--ring)}
  .btn-primary{background:linear-gradient(180deg,var(--primary),var(--primary-2));border:none;color:#06242a}
  .btn-pill{border-radius:999px}

  .week{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px}
  .dow{padding:10px;text-align:center;color:var(--muted);font-weight:600;border-bottom:1px dashed #233355}

  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .cell{
    aspect-ratio:1/1.05; position:relative; padding:10px; border:1px solid var(--line); border-radius:14px;
    background:radial-gradient(1200px 300px at 50% 0, rgba(255,255,255,.03), transparent 60%), #0a1120;
    cursor:pointer; transition:.18s; overflow:hidden;
  }
  .cell:hover{transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .cell .num{font-weight:700; font-size:14px; color:#cbd5e1}
  .muted{opacity:.35}
  .sun{color:#fca5a5}
  .holiday{outline:2px dashed #eab308; outline-offset:-6px}
  /* photo badge (count / camera) */
  .badge{
    position:absolute; right:10px; bottom:10px; display:flex; align-items:center; gap:6px;
    background:rgba(34,211,238,.12); border:1px solid #1b2d3b; padding:4px 8px; border-radius:999px; font-size:12px;
  }
  .badge .cam{font-size:14px}
  .thumbs{position:absolute; left:6px; bottom:6px; display:flex; gap:4px}
  .thumbs img{width:18px;height:18px;border-radius:4px;object-fit:cover;opacity:.9;border:1px solid #253557}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(3,6,13,.7); backdrop-filter:blur(4px); z-index:50}
  .modal.show{display:flex}
  .sheet{width:min(100%, 980px); max-height:90vh; overflow:hidden; background:#0b1220; border:1px solid var(--line);
    border-radius:18px; box-shadow:0 30px 70px rgba(0,0,0,.6); display:grid; grid-template-rows:auto auto 1fr auto}
  .sheet-head{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--line)}
  .sheet-head h3{margin:0;font-size:18px}
  .sheet-sub{color:var(--muted); font-size:12px}
  .close{background:transparent;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:8px 10px;cursor:pointer}
  .uploader{padding:12px 18px; display:flex; gap:12px; align-items:center; border-bottom:1px dashed #233355}
  .input-file{display:inline-flex; align-items:center; gap:8px; background:#0a1324; border:1px dashed #2b3b63; padding:10px 12px; border-radius:12px}
  .input-file input{appearance:none}
  .btn-upload{background:linear-gradient(180deg,var(--primary),var(--primary-2)); border:none; color:#07262b; font-weight:700}
  .gallery{padding:16px 18px; overflow:auto}
  .grid-photos{display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px}
  .tile{position:relative; border:1px solid #243247; border-radius:14px; overflow:hidden; background:#0a1324}
  .tile img{width:100%; height:160px; object-fit:cover; display:block}
  .tile .tools{position:absolute; inset:auto 8px 8px 8px; display:flex; gap:8px; justify-content:flex-end}
  .tool{background:rgba(17,24,39,.7); border:1px solid #253557; color:#dbeafe; padding:6px 10px; border-radius:10px; font-size:12px; cursor:pointer}
  .tool:hover{background:rgba(17,24,39,.9)}
  .empty{color:var(--muted); text-align:center; padding:40px 12px}

  /* Toast */
  .toast{position:fixed; right:16px; bottom:16px; padding:10px 14px; border-radius:12px; background:#041120; border:1px solid #223455;
    color:var(--text); box-shadow:0 8px 30px rgba(0,0,0,.35); display:none}
  .toast.show{display:block}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><span class="dot"></span><h1>Work Calendar</h1></div>
    <div class="hint">Shared daily photo log â€¢ everyone can view & download</div>
  </div>

  <div class="wrap">
    <div class="card calendar">
      <div class="cal-head">
        <div class="cal-title"><span id="monthTitle">Loadingâ€¦</span></div>
        <div class="seg">
          <button class="btn btn-pill" id="prevBtn">â—€ Prev</button>
          <button class="btn btn-pill" id="todayBtn">Today</button>
          <button class="btn btn-pill" id="nextBtn">Next â–¶</button>
        </div>
      </div>

      <!-- Day of week header -->
      <div class="week">
        <div class="dow">Sun</div><div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div>
        <div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div>
      </div>

      <!-- Calendar grid -->
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheet-head">
        <div>
          <h3 id="modalTitle">Photos</h3>
          <div class="sheet-sub">Upload multiple images â€” visible to everyone</div>
        </div>
        <button class="close" id="closeModal">âœ• Close</button>
      </div>

      <div class="uploader">
        <label class="input-file">
          ðŸ“· Choose imagesâ€¦
          <input type="file" id="fileInput" accept="image/*" multiple>
        </label>
        <button class="btn btn-upload" id="uploadBtn">Upload</button>
        <div class="sheet-sub" id="uploadHint">PNG/JPG recommended</div>
      </div>

      <div class="gallery">
        <div class="grid-photos" id="photoGrid"></div>
        <div class="empty" id="emptyMsg" style="display:none">No photos yet for this date.</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Uploaded!</div>

<script>
/* ====== CONFIG ====== */
const API = "https://script.google.com/macros/s/AKfycbzoCDR2Ajs7RO2WrF_pTXR8xa8qeex5nMYSobx-ZyA2S_HJ0ou66nvm4lbwfc5lMH2f/exec"; // your Apps Script URL
// Highlight Tamil Nadu govt holidays (add as needed - YYYY-MM-DD)
const HOLIDAYS_TN = new Set([
  "2025-01-01","2025-01-14","2025-01-15","2025-04-14","2025-05-01","2025-08-15","2025-10-02","2025-10-22","2025-12-25"
]);

/* ====== STATE ====== */
let focus = new Date();
let monthData = {};   // { "YYYY-MM-DD": [{name,url,thumb}] }
let activeDateStr = null;
let queueFiles = [];

/* ====== HELPERS ====== */
const pad = n => String(n).padStart(2,"0");
const ymd = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const monthKey = (y,m) => `${y}-${pad(m+1)}`;

/* Robust fetch: support either mapping {date:[...]} or flat array [{name,url,thumb,date}] */
async function fetchAll() {
  const res = await fetch(API);
  const json = await res.json();
  if (Array.isArray(json)) {
    // try to infer date from filename at start: YYYY-MM-DD_
    const map = {};
    json.forEach(it => {
      let dk = it.date || (it.name && it.name.match(/^(\d{4}-\d{2}-\d{2})[_-]/)?.[1]) || null;
      if (!dk) return;
      (map[dk] ||= []).push({
        name: it.name,
        url: it.url || it.webContentLink || it.webViewLink || it.thumb,
        thumb: it.thumb || it.url
      });
    });
    monthData = map;
  } else {
    monthData = json; // already keyed by date
  }
}

/* Convert File -> dataURL (base64) */
function fileToDataURL(file) {
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function showToast(text="Done") {
  const t = document.getElementById("toast");
  t.textContent = text;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1600);
}

/* ====== CALENDAR RENDER ====== */
function renderCalendar() {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  const year = focus.getFullYear();
  const month = focus.getMonth();
  const first = new Date(year, month, 1);
  const last = new Date(year, month+1, 0);
  document.getElementById("monthTitle").textContent =
    first.toLocaleString('default', {month:'long'}) + " " + year;

  // leading blanks
  for (let i=0;i<first.getDay();i++) {
    const blank = document.createElement("div");
    grid.appendChild(blank);
  }

  for (let d=1; d<=last.getDate(); d++) {
    const date = new Date(year, month, d);
    const dateStr = ymd(date);
    const cell = document.createElement("div");
    cell.className = "cell";
    const isSun = date.getDay()===0;
    if (isSun) cell.classList.add("sun");
    if (HOLIDAYS_TN.has(dateStr)) cell.classList.add("holiday");

    // number
    const num = document.createElement("div");
    num.className = "num";
    num.textContent = d;
    cell.appendChild(num);

    // tiny thumbs row (up to 3)
    const photos = monthData[dateStr] || [];
    if (photos.length) {
      const thumbs = document.createElement("div");
      thumbs.className = "thumbs";
      photos.slice(0,3).forEach(p=>{
        const im = document.createElement("img");
        im.src = p.thumb || p.url;
        thumbs.appendChild(im);
      });
      cell.appendChild(thumbs);

      // badge with camera + count
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.innerHTML = `<span class="cam">ðŸ“·</span> ${photos.length}`;
      cell.appendChild(badge);
    }

    cell.addEventListener("click", ()=> openModal(dateStr));
    grid.appendChild(cell);
  }
}

/* ====== MODAL & GALLERY ====== */
function openModal(dateStr) {
  activeDateStr = dateStr;
  document.getElementById("modalTitle").textContent = `Photos â€¢ ${dateStr}`;
  queueFiles = [];
  document.getElementById("fileInput").value = "";
  renderGallery(dateStr);
  document.getElementById("modal").classList.add("show");
}
function closeModal(){ document.getElementById("modal").classList.remove("show"); }

function renderGallery(dateStr) {
  const list = monthData[dateStr] || [];
  const grid = document.getElementById("photoGrid");
  const empty = document.getElementById("emptyMsg");
  grid.innerHTML = "";
  empty.style.display = list.length ? "none" : "block";

  list.forEach((p,i)=>{
    const tile = document.createElement("div");
    tile.className = "tile";
    const img = document.createElement("img");
    img.src = p.url || p.thumb;
    img.alt = p.name || ("photo-"+i);
    tile.appendChild(img);

    const tools = document.createElement("div");
    tools.className = "tools";

    // open large
    const openBtn = document.createElement("button");
    openBtn.className = "tool";
    openBtn.textContent = "Open";
    openBtn.onclick = ()=> window.open(p.url || p.thumb, "_blank");
    tools.appendChild(openBtn);

    // download
    const dlBtn = document.createElement("button");
    dlBtn.className = "tool";
    dlBtn.textContent = "Download";
    dlBtn.onclick = ()=>{
      const a = document.createElement("a");
      a.href = (p.url || p.thumb);
      a.download = p.name || "photo.jpg";
      document.body.appendChild(a);
      a.click();
      a.remove();
    };
    tools.appendChild(dlBtn);

    tile.appendChild(tools);
    grid.appendChild(tile);
  });
}

/* ====== UPLOAD ====== */
document.getElementById("fileInput").addEventListener("change", (e)=>{
  queueFiles = Array.from(e.target.files || []);
  document.getElementById("uploadHint").textContent =
    queueFiles.length ? `${queueFiles.length} file(s) ready` : "PNG/JPG recommended";
});

document.getElementById("uploadBtn").addEventListener("click", async ()=>{
  if (!activeDateStr) return;
  if (!queueFiles.length) { showToast("Choose images first"); return; }

  // upload sequentially to avoid Apps Script size quirks
  for (const f of queueFiles) {
    const dataUrl = await fileToDataURL(f);
    await fetch(API, {
      method: "POST",
      headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
      body: new URLSearchParams({ date: activeDateStr, image: dataUrl })
    }).then(r=>r.json()).catch(()=>({success:false}));
  }
  showToast("Uploaded!");
  await fetchAll();
  renderCalendar();
  renderGallery(activeDateStr);
  queueFiles = [];
  document.getElementById("fileInput").value = "";
  document.getElementById("uploadHint").textContent = "Uploaded";
});

/* ====== NAV ====== */
document.getElementById("prevBtn").onclick = ()=>{ focus.setMonth(focus.getMonth()-1); renderCalendar(); };
document.getElementById("nextBtn").onclick = ()=>{ focus.setMonth(focus.getMonth()+1); renderCalendar(); };
document.getElementById("todayBtn").onclick = ()=>{ focus = new Date(); renderCalendar(); };
document.getElementById("closeModal").onclick = closeModal;

/* ====== INIT ====== */
(async function init(){
  await fetchAll();
  renderCalendar();
})();
</script>
</body>
</html>
